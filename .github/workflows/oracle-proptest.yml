name: oracle-proptest

on:
  workflow_dispatch:
    inputs:
      install_emacs:
        description: "Install emacs-nox if Emacs is not already available"
        required: false
        type: boolean
        default: true
      test_filter:
        description: "nextest substring filter"
        required: false
        type: string
        default: "elisp::oracle::"
      min_primitive_coverage_pct:
        description: "minimum primitive oracle coverage percent"
        required: false
        type: string
        default: "2.5"
      min_special_form_coverage_pct:
        description: "minimum special-form oracle coverage percent"
        required: false
        type: string
        default: "40.0"

jobs:
  neovm-core-oracle-proptest:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Optionally install Emacs
        if: ${{ inputs.install_emacs }}
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y emacs-nox

      - name: Detect Emacs
        id: emacs
        run: |
          if command -v emacs >/dev/null 2>&1; then
            echo "available=true" >> "$GITHUB_OUTPUT"
            echo "path=$(command -v emacs)" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install Rust nightly
        if: ${{ steps.emacs.outputs.available == 'true' }}
        uses: dtolnay/rust-toolchain@nightly

      - name: Install cargo-nextest
        if: ${{ steps.emacs.outputs.available == 'true' }}
        uses: taiki-e/install-action@nextest

      - name: Cache cargo artifacts
        if: ${{ steps.emacs.outputs.available == 'true' }}
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            rust/neovm-core

      - name: Run oracle coverage gate
        if: ${{ steps.emacs.outputs.available == 'true' }}
        env:
          NEOVM_ENABLE_ORACLE_PROPTEST: "1"
          NEOVM_FORCE_ORACLE_PATH: ${{ steps.emacs.outputs.path }}
          NEOVM_ORACLE_MIN_PRIMITIVE_COVERAGE_PCT: ${{ inputs.min_primitive_coverage_pct }}
          NEOVM_ORACLE_MIN_SPECIAL_FORM_COVERAGE_PCT: ${{ inputs.min_special_form_coverage_pct }}
        run: |
          RUSTFLAGS='-Awarnings' cargo nextest run \
            --manifest-path rust/neovm-core/Cargo.toml \
            "elisp::oracle::coverage::oracle_prop_coverage_snapshot"

      - name: Run oracle property tests
        if: ${{ steps.emacs.outputs.available == 'true' }}
        env:
          NEOVM_ENABLE_ORACLE_PROPTEST: "1"
          NEOVM_FORCE_ORACLE_PATH: ${{ steps.emacs.outputs.path }}
          NEOVM_ORACLE_MIN_PRIMITIVE_COVERAGE_PCT: ${{ inputs.min_primitive_coverage_pct }}
          NEOVM_ORACLE_MIN_SPECIAL_FORM_COVERAGE_PCT: ${{ inputs.min_special_form_coverage_pct }}
        run: |
          RUSTFLAGS='-Awarnings' cargo nextest run \
            --manifest-path rust/neovm-core/Cargo.toml \
            "${{ inputs.test_filter }}"

      - name: Skip summary
        if: ${{ steps.emacs.outputs.available != 'true' }}
        run: |
          echo "Skipping oracle-proptest: Emacs not found on PATH."

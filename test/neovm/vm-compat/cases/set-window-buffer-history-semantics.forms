; `set-window-buffer` should update history lists only when the buffer changes.

(let* ((w (selected-window))
       (b1 (get-buffer-create "swb-hist-a"))
       (b2 (get-buffer-create "swb-hist-b"))
       (next '((foo 1 2))))
  (with-current-buffer b1
    (erase-buffer)
    (insert (make-string 300 ?a)))
  (with-current-buffer b2
    (erase-buffer)
    (insert (make-string 300 ?b)))
  (set-window-prev-buffers w nil)
  (set-window-next-buffers w nil)
  (set-window-buffer w b1)
  (set-window-start w 7)
  (set-window-point w 11)
  (set-window-next-buffers w next)
  (set-window-buffer w b2)
  (list (null (window-next-buffers w))
        (mapcar (lambda (e) (buffer-name (car e))) (window-prev-buffers w))
        (mapcar (lambda (e)
                  (list (markerp (nth 1 e))
                        (marker-position (nth 1 e))
                        (markerp (nth 2 e))
                        (marker-position (nth 2 e))))
                (window-prev-buffers w))))

(let* ((w (selected-window))
       (same (window-buffer w))
       (next '((foo 1 2)))
       (before (window-prev-buffers w)))
  (set-window-next-buffers w next)
  (set-window-buffer w same)
  (list (equal (window-prev-buffers w) before)
        (equal (window-next-buffers w) next)))

(let* ((w (selected-window))
       (b1 (get-buffer-create "swb-hist-d1"))
       (b2 (get-buffer-create "swb-hist-d2")))
  (set-window-prev-buffers w nil)
  (set-window-buffer w b1)
  (set-window-buffer w b2)
  (set-window-buffer w b1)
  (set-window-buffer w b2)
  (mapcar (lambda (e) (buffer-name (car e))) (window-prev-buffers w)))

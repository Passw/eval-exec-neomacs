; NeoVM extension behavior: source precompile to .neoc sidecar.
(setq vm-precompile-dir "/tmp/neovm-precompile-vm-compat/")
(progn (ignore-errors (delete-directory vm-precompile-dir t)) (make-directory vm-precompile-dir t) 'ok)

(setq vm-precompile-source (concat vm-precompile-dir "probe.el"))
(setq vm-precompile-cache (concat vm-precompile-dir "probe.neoc"))
(setq vm-precompile-elc (concat vm-precompile-dir "probe.elc"))

(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-precompile-src*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert ";;; -*- lexical-binding: t; -*-")
        (insert (char-to-string 10))
        (insert "(setq vm-precompile-probe 'cached)")
        (insert (char-to-string 10))
        (write-region nil nil vm-precompile-source nil nil))
    (set-buffer orig)
    (kill-buffer buf)))
(file-exists-p vm-precompile-source)

(string-suffix-p ".neoc" (neovm-precompile-file vm-precompile-source))
(file-exists-p vm-precompile-cache)

(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-precompile-elc*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert "compiled-artifact")
        (write-region nil nil vm-precompile-elc nil nil))
    (set-buffer orig)
    (kill-buffer buf)))
(condition-case err (neovm-precompile-file vm-precompile-elc) (error (car err)))

(delete-file vm-precompile-source)
(delete-file vm-precompile-cache)
(delete-file vm-precompile-elc)

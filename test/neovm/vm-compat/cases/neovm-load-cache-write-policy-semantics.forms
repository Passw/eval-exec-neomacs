; NeoVM policy under vm-compat runner:
; - `run-neovm.sh` sets NEOVM_DISABLE_LOAD_CACHE_WRITE=1
; - `load-file` must not emit `.neoc` sidecars in this mode
; - explicit `neovm-precompile-file` still emits `.neoc`

(setq vm-load-cache-policy-dir "/tmp/neovm-load-cache-write-policy/")
(progn (ignore-errors (delete-directory vm-load-cache-policy-dir t)) (make-directory vm-load-cache-policy-dir t) 'ok)

(setq vm-load-cache-policy-source (concat vm-load-cache-policy-dir "probe.el"))
(setq vm-load-cache-policy-cache (concat vm-load-cache-policy-dir "probe.neoc"))

(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-load-cache-policy-src*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert "(setq vm-load-cache-policy-probe 'source)")
        (insert (char-to-string 10))
        (write-region nil nil vm-load-cache-policy-source nil nil))
    (set-buffer orig)
    (kill-buffer buf)))

(file-exists-p vm-load-cache-policy-cache)

(load-file vm-load-cache-policy-source)
(boundp 'vm-load-cache-policy-probe)
(eq vm-load-cache-policy-probe 'source)
(file-exists-p vm-load-cache-policy-cache)

(string= (neovm-precompile-file vm-load-cache-policy-source) vm-load-cache-policy-cache)
(file-exists-p vm-load-cache-policy-cache)

(delete-file vm-load-cache-policy-source)
(delete-file vm-load-cache-policy-cache)
(delete-directory vm-load-cache-policy-dir t)

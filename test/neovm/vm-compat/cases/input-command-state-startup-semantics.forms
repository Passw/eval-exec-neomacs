(setq neovm-startup-command-state-bound-symbols
      '(last-event-frame
        last-event-device
        last-input-event
        last-nonmenu-event
        last-command-event
        real-last-command
        last-repeatable-command
        this-original-command
        prefix-arg
        defining-kbd-macro
        executing-kbd-macro
        executing-kbd-macro-index
        command-history
        command-line-args-left
        command-line-functions
        command-line-processed
        command-switch-alist
        command-line-default-directory
        command-line-args
        command-line-ns-option-alist
        command-line-x-option-alist
        extended-command-history
        completion-ignore-case
        read-buffer-completion-ignore-case
        read-file-name-completion-ignore-case
        completion-regexp-list
        completion--cycling-threshold-type
        completion--styles-type
        completion-at-point-functions
        completion-setup-hook
        completion-in-region-mode-map
        completion-list-mode-abbrev-table
        completion-list-mode-hook
        completion-list-mode-map
        completion-list-mode-syntax-table
        completion-ignored-extensions
        completion--all-sorted-completions-location
        completion--capf-misbehave-funs
        completion--capf-safe-funs
        completion--embedded-envvar-re
        completion--flex-score-last-md
        completion-all-sorted-completions
        completion-styles
        completion-styles-alist
        completion-category-defaults
        completion-category-overrides
        completion-cycle-threshold
        completions-detailed
        completions-format
        completions-group
        completions-group-format
        completions-group-sort
        completions-header-format
        completions-highlight-face
        completions-max-height
        completions-sort
        completion-auto-help
        completion-auto-deselect
        completion-auto-select
        completion-auto-wrap
        completion-base-position
        completion-cycling
        completion-extra-properties
        completion-fail-discreetly
        completion-flex-nospace
        completion-in-region--data
        completion-in-region-function
        completion-in-region-functions
        completion-in-region-mode
        completion-in-region-mode--predicate
        completion-in-region-mode-hook
        completion-in-region-mode-predicate
        completion-show-help
        completion-show-inline-help
        completion-lazy-hilit
        completion-lazy-hilit-fn
        completion-list-insert-choice-function
        completion-no-auto-exit
        completion-pcm--delim-wild-regex
        completion-pcm--regexp
        completion-pcm-complete-word-inserts-delimiters
        completion-pcm-word-delimiters
        completion-reference-buffer
        completion-tab-width
        enable-recursive-minibuffers
        history-length
        history-delete-duplicates
        history-add-new-input
        read-buffer-function
        read-file-name-function
        read-expression-history
        read-number-history
        read-char-history
        read-answer-short
        read-char-by-name-sort
        read-char-choice-use-read-key
        read-circle
        read-envvar-name-history
        read-face-name-sample-text
        read-key-delay
        read-answer-map--memoize
        read-char-from-minibuffer-map
        read-char-from-minibuffer-map-hash
        read-expression-map
        read--expression-map
        read-extended-command-mode-map
        read-key-empty-map
        read-key-full-map
        read-regexp-map
        read-extended-command-mode
        read-extended-command-mode-hook
        read-extended-command-predicate
        read-hide-char
        read-mail-command
        read-minibuffer-restore-windows
        read-only-mode-hook
        read-process-output-max
        read-quoted-char-radix
        read-regexp--case-fold
        read-regexp-defaults-function
        read-symbol-shorthands
        minibuffer-frame-alist
        minibuffer-inactive-mode-abbrev-table
        minibuffer-inactive-mode-hook
        minibuffer-inactive-mode-map
        minibuffer-inactive-mode-syntax-table
        minibuffer-mode-abbrev-table
        minibuffer-mode-hook
        minibuffer-mode-map
        minibuffer-local-map
        minibuffer-local-completion-map
        minibuffer-local-filename-completion-map
        minibuffer-local-filename-syntax
        minibuffer-local-isearch-map
        minibuffer-local-must-match-map
        minibuffer-local-ns-map
        minibuffer-local-shell-command-map
        minibuffer-history
        minibuffer-history-variable
        minibuffer-history-position
        minibuffer-history-isearch-message-overlay
        minibuffer-history-search-history
        minibuffer-history-sexp-flag
        minibuffer-default
        minibuffer-default-add-done
        minibuffer-default-add-function
        minibuffer--original-buffer
        minibuffer--regexp-primed
        minibuffer--regexp-prompt-regexp
        minibuffer--require-match
        minibuffer-auto-raise
        minibuffer-follows-selected-frame
        minibuffer-exit-hook
        minibuffer-completion-table
        minibuffer-completion-predicate
        minibuffer-completion-confirm
        minibuffer-completion-auto-choose
        minibuffer-completion-base
        minibuffer-help-form
        minibuffer-completing-file-name
        minibuffer-regexp-mode
        minibuffer-regexp-mode-hook
        minibuffer-regexp-prompts
        minibuffer-message-clear-timeout
        minibuffer-message-overlay
        minibuffer-message-properties
        minibuffer-message-timeout
        minibuffer-message-timer
        minibuffer-lazy-count-format
        minibuffer-text-before-history
        minibuffer-prompt-properties
        minibuffer-allow-text-properties
        minibuffer-scroll-window
        minibuffer-visible-completions
        minibuffer-visible-completions--always-bind
        minibuffer-visible-completions-map
        minibuffer-depth-indicate-mode
        minibuffer-default-prompt-format
        minibuffer-beginning-of-buffer-movement
        minibuffer-electric-default-mode
        minibuffer-temporary-goal-position
        minibuffer-confirm-exit-commands
        minibuffer-history-case-insensitive-variables
        minibuffer-on-screen-keyboard-displayed
        minibuffer-on-screen-keyboard-timer
        minibuffer-setup-hook
        regexp-search-ring
        regexp-search-ring-max
        regexp-search-ring-yank-pointer
        search-ring
        search-ring-max
        search-ring-update
        search-ring-yank-pointer
        executing-kbd-macro-prefix-arg
        last-prefix-arg
        last-kbd-macro
        last-code-conversion-error
        last-coding-system-specified
        last-coding-system-used
        last-next-selection-coding-system
        last-abbrev
        last-abbrev-location
        last-abbrev-text
        command-debug-status
        command-error-function
        key-substitution-in-progress
        this-command
        real-this-command
        this-command-keys-shift-translated
        current-prefix-arg
        track-mouse
        throw-on-input
        while-no-input-ignore-events
        overriding-local-map
        overriding-local-map-menu-flag
        overriding-plist-environment
        overriding-terminal-local-map
        overriding-text-conversion-style
        deactivate-mark
        mark-active
        mark-even-if-inactive
        mark-ring
        mark-ring-max
        saved-region-selection
        transient-mark-mode
        transient-mark-mode-hook
        unread-input-method-events
        unread-post-input-method-events
        input-method-alist
        input-method-activate-hook
        input-method-after-insert-chunk-hook
        input-method-deactivate-hook
        input-method-exit-on-first-char
        input-method-exit-on-invalid-key
        input-method-function
        input-method-highlight-flag
        input-method-history
        input-method-previous-message
        input-method-use-echo-area
        input-method-verbose-flag
        unread-command-events))

(setq neovm-startup-command-state-value-symbols
      '(last-event-frame
        last-event-device
        last-input-event
        last-nonmenu-event
        last-command-event
        real-last-command
        last-repeatable-command
        this-original-command
        prefix-arg
        defining-kbd-macro
        executing-kbd-macro
        executing-kbd-macro-index
        command-history
        command-line-args-left
        command-line-functions
        command-line-processed
        command-switch-alist
        extended-command-history
        completion-ignore-case
        read-buffer-completion-ignore-case
        read-file-name-completion-ignore-case
        completion-regexp-list
        completion-at-point-functions
        completion-setup-hook
        completion-list-mode-hook
        completion--all-sorted-completions-location
        completion--capf-misbehave-funs
        completion--capf-safe-funs
        completion--embedded-envvar-re
        completion--flex-score-last-md
        completion-all-sorted-completions
        completion-styles
        completion-category-defaults
        completion-category-overrides
        completion-cycle-threshold
        completions-detailed
        completions-format
        completions-group
        completions-group-sort
        completions-highlight-face
        completions-max-height
        completions-sort
        completion-auto-help
        completion-auto-deselect
        completion-auto-select
        completion-auto-wrap
        completion-base-position
        completion-cycling
        completion-extra-properties
        completion-fail-discreetly
        completion-flex-nospace
        completion-in-region--data
        completion-in-region-function
        completion-in-region-functions
        completion-in-region-mode
        completion-in-region-mode--predicate
        completion-in-region-mode-hook
        completion-in-region-mode-predicate
        completion-show-help
        completion-show-inline-help
        completion-lazy-hilit
        completion-lazy-hilit-fn
        completion-list-insert-choice-function
        completion-no-auto-exit
        completion-pcm--delim-wild-regex
        completion-pcm--regexp
        completion-pcm-complete-word-inserts-delimiters
        completion-pcm-word-delimiters
        completion-reference-buffer
        completion-tab-width
        enable-recursive-minibuffers
        history-length
        history-delete-duplicates
        history-add-new-input
        read-buffer-function
        read-file-name-function
        read-expression-history
        read-number-history
        read-char-history
        read-answer-short
        read-char-by-name-sort
        read-char-choice-use-read-key
        read-circle
        read-envvar-name-history
        read-face-name-sample-text
        read-key-delay
        read-extended-command-mode
        read-extended-command-mode-hook
        read-extended-command-predicate
        read-hide-char
        read-mail-command
        read-minibuffer-restore-windows
        read-only-mode-hook
        read-process-output-max
        read-quoted-char-radix
        read-regexp--case-fold
        read-regexp-defaults-function
        read-symbol-shorthands
        minibuffer-frame-alist
        minibuffer-inactive-mode-hook
        minibuffer-mode-hook
        minibuffer-history
        minibuffer-history-variable
        minibuffer-history-position
        minibuffer-history-isearch-message-overlay
        minibuffer-history-search-history
        minibuffer-history-sexp-flag
        minibuffer-default
        minibuffer-default-add-done
        minibuffer-default-add-function
        minibuffer--original-buffer
        minibuffer--regexp-primed
        minibuffer--regexp-prompt-regexp
        minibuffer--require-match
        minibuffer-auto-raise
        minibuffer-follows-selected-frame
        minibuffer-exit-hook
        minibuffer-completion-table
        minibuffer-completion-predicate
        minibuffer-completion-confirm
        minibuffer-completion-auto-choose
        minibuffer-completion-base
        minibuffer-help-form
        minibuffer-completing-file-name
        minibuffer-regexp-mode
        minibuffer-regexp-mode-hook
        minibuffer-regexp-prompts
        minibuffer-message-clear-timeout
        minibuffer-message-overlay
        minibuffer-message-properties
        minibuffer-message-timeout
        minibuffer-message-timer
        minibuffer-lazy-count-format
        minibuffer-text-before-history
        minibuffer-prompt-properties
        minibuffer-allow-text-properties
        minibuffer-scroll-window
        minibuffer-visible-completions
        minibuffer-visible-completions--always-bind
        minibuffer-depth-indicate-mode
        minibuffer-default-prompt-format
        minibuffer-beginning-of-buffer-movement
        minibuffer-electric-default-mode
        minibuffer-temporary-goal-position
        minibuffer-confirm-exit-commands
        minibuffer-history-case-insensitive-variables
        minibuffer-on-screen-keyboard-displayed
        minibuffer-on-screen-keyboard-timer
        minibuffer-setup-hook
        regexp-search-ring
        regexp-search-ring-max
        regexp-search-ring-yank-pointer
        search-ring
        search-ring-max
        search-ring-update
        search-ring-yank-pointer
        last-prefix-arg
        last-kbd-macro
        last-code-conversion-error
        last-coding-system-specified
        last-coding-system-used
        last-next-selection-coding-system
        last-abbrev
        last-abbrev-location
        last-abbrev-text
        command-debug-status
        command-error-function
        key-substitution-in-progress
        this-command
        real-this-command
        this-command-keys-shift-translated
        current-prefix-arg
        track-mouse
        throw-on-input
        while-no-input-ignore-events
        overriding-local-map
        overriding-local-map-menu-flag
        overriding-plist-environment
        overriding-terminal-local-map
        overriding-text-conversion-style
        deactivate-mark
        mark-active
        mark-even-if-inactive
        mark-ring
        mark-ring-max
        saved-region-selection
        transient-mark-mode
        transient-mark-mode-hook
        unread-input-method-events
        unread-post-input-method-events
        input-method-activate-hook
        input-method-after-insert-chunk-hook
        input-method-deactivate-hook
        input-method-exit-on-first-char
        input-method-exit-on-invalid-key
        input-method-function
        input-method-highlight-flag
        input-method-history
        input-method-previous-message
        input-method-use-echo-area
        input-method-verbose-flag))

(setq neovm-startup-command-state-shape-symbols
      '(command-line-default-directory
        command-line-args
        command-line-ns-option-alist
        command-line-x-option-alist
        completion-ignored-extensions
        completion--cycling-threshold-type
        completion--styles-type
        completion-in-region-mode-map
        completion-list-mode-map
        completion-list-mode-syntax-table
        completion-styles-alist
        completions-format
        completions-group-format
        completions-header-format
        completions-highlight-face
        completions-sort
        minibuffer-frame-alist
        minibuffer-inactive-mode-map
        minibuffer-inactive-mode-syntax-table
        minibuffer-local-completion-map
        minibuffer-local-filename-completion-map
        minibuffer-local-filename-syntax
        minibuffer-local-isearch-map
        minibuffer-local-map
        minibuffer-local-must-match-map
        minibuffer-local-ns-map
        minibuffer-local-shell-command-map
        minibuffer-mode-map
        minibuffer-visible-completions-map
        read--expression-map
        read-answer-map--memoize
        read-char-from-minibuffer-map
        read-char-from-minibuffer-map-hash
        read-expression-map
        read-extended-command-mode-map
        read-key-empty-map
        read-key-full-map
        read-regexp-map))

(setq neovm-reader-command-state-symbols
      (delq nil
            (mapcar
             (lambda (sym)
               (unless (memq sym
                             '(last-command-event
                               last-prefix-arg
                               last-kbd-macro
                               last-code-conversion-error
                               last-coding-system-used))
                 sym))
             neovm-startup-command-state-value-symbols)))

(mapcar
 (lambda (sym) (list sym (boundp sym)))
 neovm-startup-command-state-bound-symbols)

; Oracle startup seeds input-method-alist as a list object.
; Keep only list-ness (not full content) locked for now.
(list (boundp 'input-method-alist)
      (listp input-method-alist))

(mapcar
 (lambda (sym)
   (let ((v (symbol-value sym)))
     (list sym
           (boundp sym)
           (cond
            ((keymapp v) 'keymap)
            ((hash-table-p v) 'hash-table)
            ((syntax-table-p v) 'syntax-table)
            ((stringp v) 'string)
            ((symbolp v) 'symbol)
            ((consp v) 'cons)
            ((null v) 'nil)
            ((eq v t) 't)
            (t 'other)))))
 neovm-startup-command-state-shape-symbols)

(mapcar (lambda (sym) (symbol-value sym))
        neovm-startup-command-state-value-symbols)

(progn
  (setq unread-command-events (list 97))
  (read-key nil)
  (mapcar (lambda (sym) (symbol-value sym))
          neovm-reader-command-state-symbols))

(progn
  (setq unread-command-events (list '(mouse-1)))
  (read-event nil nil 0)
  (mapcar (lambda (sym) (symbol-value sym))
          neovm-reader-command-state-symbols))

; Prompt/input readers in batch preserve startup command/input state variables
; while signaling end-of-file on queued unread events.
(let ((probes
       '((read-string "")
         (read-number "")
         (read-from-minibuffer "")
         (completing-read "" (("a") ("b")))
         (read-command "")
         (read-variable "")
         (read-buffer "")
         (read-file-name ""))))
  (mapcar
   (lambda (entry)
     (let ((fn (car entry))
           (args (cdr entry))
           (before (mapcar (lambda (sym) (symbol-value sym))
                           neovm-reader-command-state-symbols)))
       (condition-case _
           (progn
             (setq unread-command-events (list 97 'foo))
             (apply fn args))
         (error nil))
       (list fn
             before
             (mapcar (lambda (sym) (symbol-value sym))
                     neovm-reader-command-state-symbols)
             unread-command-events)))
   probes))

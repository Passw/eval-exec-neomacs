; NeoVM extension policy: `neovm-precompile-file` returns the exact
; `.neoc` sidecar path and remains stable across repeated precompile calls.

(setq vm-precompile-ret-dir "/tmp/neovm-precompile-return-path/")
(progn (ignore-errors (delete-directory vm-precompile-ret-dir t)) (make-directory vm-precompile-ret-dir t) 'ok)

(setq vm-precompile-ret-source (concat vm-precompile-ret-dir "probe.el"))
(setq vm-precompile-ret-cache (concat vm-precompile-ret-dir "probe.neoc"))

(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-precompile-ret-src*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert ";;; -*- lexical-binding: t; -*-")
        (insert (char-to-string 10))
        (insert "(setq vm-precompile-ret-probe 'ok)")
        (insert (char-to-string 10))
        (write-region nil nil vm-precompile-ret-source nil nil))
    (set-buffer orig)
    (kill-buffer buf)))

(let ((out (neovm-precompile-file vm-precompile-ret-source)))
  (and
   (stringp out)
   (string= out vm-precompile-ret-cache)
   (file-exists-p out)
   (file-exists-p vm-precompile-ret-cache)))

(let ((out (neovm-precompile-file vm-precompile-ret-source)))
  (and
   (stringp out)
   (string= out vm-precompile-ret-cache)
   (file-exists-p out)
   (file-exists-p vm-precompile-ret-cache)))

(delete-file vm-precompile-ret-source)
(delete-file vm-precompile-ret-cache)
(delete-directory vm-precompile-ret-dir t)

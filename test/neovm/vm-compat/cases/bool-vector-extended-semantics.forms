(fboundp 'bool-vector-not)
(subrp (symbol-function 'bool-vector-not))
(subr-arity (symbol-function 'bool-vector-not))
(fboundp 'bool-vector-count-consecutive)
(subrp (symbol-function 'bool-vector-count-consecutive))
(subr-arity (symbol-function 'bool-vector-count-consecutive))
(fboundp 'bool-vector-set-difference)
(subrp (symbol-function 'bool-vector-set-difference))
(subr-arity (symbol-function 'bool-vector-set-difference))

(defun vm-bv-bits (bv len)
  (let ((idx 0)
         (out nil))
    (while (< idx len)
      (setq out (cons (if (aref bv idx) t nil) out))
      (setq idx (1+ idx)))
    (nreverse out)))

(let ((a (make-bool-vector 4 nil)))
  (aset a 0 t)
  (aset a 2 t)
  (list 'not-new (vm-bv-bits (bool-vector-not a) 4) (vm-bv-bits a 4)))

(let ((a (make-bool-vector 4 nil))
      (dest (make-bool-vector 4 nil)))
  (aset a 0 t)
  (aset a 2 t)
  (let ((ret (bool-vector-not a dest)))
    (list 'not-dest (eq ret dest) (vm-bv-bits dest 4) (vm-bv-bits a 4))))

(let ((a (make-bool-vector 4 nil))
      (b (make-bool-vector 4 nil)))
  (aset a 0 t)
  (aset a 1 t)
  (aset a 3 t)
  (aset b 1 t)
  (aset b 2 t)
  (list 'set-diff-new (vm-bv-bits (bool-vector-set-difference a b) 4)))

(let ((a (make-bool-vector 4 nil))
      (b (make-bool-vector 4 nil))
      (dest (make-bool-vector 4 nil)))
  (aset a 0 t)
  (aset a 1 t)
  (aset a 3 t)
  (aset b 1 t)
  (aset b 2 t)
  (let ((ret (bool-vector-set-difference a b dest)))
    (list 'set-diff-dest (eq ret dest) (vm-bv-bits dest 4))))

(let ((bv (make-bool-vector 6 nil)))
  (aset bv 0 t)
  (aset bv 1 t)
  (aset bv 4 t)
  (aset bv 5 t)
  (list 'count-consecutive
        (bool-vector-count-consecutive bv t 0)
        (bool-vector-count-consecutive bv nil 2)
        (bool-vector-count-consecutive bv t 2)
        (bool-vector-count-consecutive bv 'x 0)
        (bool-vector-count-consecutive bv t 4)
        (bool-vector-count-consecutive bv nil 6)))

(condition-case err
    (progn (bool-vector-not 7) (list 'unexpected))
  (error (list 'not-type (car err) (cdr err))))

(condition-case err
    (progn
      (let ((a (make-bool-vector 2 nil))
            (dest (make-bool-vector 1 nil)))
        (bool-vector-not a dest))
      (list 'unexpected))
  (error (list 'not-length (car err) (cdr err))))

(condition-case err
    (progn
      (bool-vector-set-difference (make-bool-vector 2 nil) (make-bool-vector 1 nil))
      (list 'unexpected))
  (error (list 'set-diff-length (car err) (cdr err))))

(condition-case err
    (progn
      (bool-vector-intersection (make-bool-vector 2 nil) (make-bool-vector 1 nil))
      (list 'unexpected))
  (error (list 'intersection-length (car err) (cdr err))))

(condition-case err
    (progn
      (bool-vector-union (make-bool-vector 2 nil) (make-bool-vector 1 nil))
      (list 'unexpected))
  (error (list 'union-length (car err) (cdr err))))

(condition-case err
    (progn
      (bool-vector-exclusive-or (make-bool-vector 2 nil) (make-bool-vector 1 nil))
      (list 'unexpected))
  (error (list 'xor-length (car err) (cdr err))))

(condition-case err
    (progn
      (bool-vector-subsetp (make-bool-vector 2 nil) (make-bool-vector 1 nil))
      (list 'unexpected))
  (error (list 'subset-length (car err) (cdr err))))

(condition-case err
    (progn
      (bool-vector-intersection
       (make-bool-vector 2 nil)
       (make-bool-vector 2 nil)
       (make-bool-vector 1 nil))
      (list 'unexpected))
  (error (list 'intersection-dest-length (car err) (cdr err))))

(condition-case err
    (progn (bool-vector-count-consecutive (make-bool-vector 1 nil) t -1) (list 'unexpected))
  (error (list 'count-neg (car err) (cdr err))))

(condition-case err
    (progn (bool-vector-count-consecutive (make-bool-vector 1 nil) t 2) (list 'unexpected))
  (args-out-of-range
   (list 'count-oob (car err) (bool-vector-p (nth 1 err)) (nth 2 err))))

(condition-case err
    (progn (bool-vector-count-consecutive 7 t 0) (list 'unexpected))
  (error (list 'count-type-bv (car err) (cdr err))))

(condition-case err
    (progn (bool-vector-count-consecutive (make-bool-vector 1 nil) t 'x) (list 'unexpected))
  (error (list 'count-type-index (car err) (cdr err))))

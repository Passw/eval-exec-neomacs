; NeoVM policy: `NEOVM_DISABLE_LOAD_CACHE_WRITE` is consulted at runtime.
; Toggling it via `setenv` changes `load-file` cache-write behavior.

(setq vm-load-cache-toggle-dir "/tmp/neovm-load-cache-write-toggle/")
(progn (ignore-errors (delete-directory vm-load-cache-toggle-dir t)) (make-directory vm-load-cache-toggle-dir t) 'ok)

(setq vm-load-cache-toggle-source (concat vm-load-cache-toggle-dir "probe.el"))
(setq vm-load-cache-toggle-cache (concat vm-load-cache-toggle-dir "probe.neoc"))

(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-load-cache-toggle-src*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert "(setq vm-load-cache-toggle-probe 'loaded)")
        (insert (char-to-string 10))
        (write-region nil nil vm-load-cache-toggle-source nil nil))
    (set-buffer orig)
    (kill-buffer buf)))

(setenv "NEOVM_DISABLE_LOAD_CACHE_WRITE" "1")
(load-file vm-load-cache-toggle-source)
(eq vm-load-cache-toggle-probe 'loaded)
(file-exists-p vm-load-cache-toggle-cache)

(setenv "NEOVM_DISABLE_LOAD_CACHE_WRITE" nil)
(delete-file vm-load-cache-toggle-cache)
(file-exists-p vm-load-cache-toggle-cache)
(load-file vm-load-cache-toggle-source)
(eq vm-load-cache-toggle-probe 'loaded)
(file-exists-p vm-load-cache-toggle-cache)

(setenv "NEOVM_DISABLE_LOAD_CACHE_WRITE" "true")
(delete-file vm-load-cache-toggle-cache)
(load-file vm-load-cache-toggle-source)
(file-exists-p vm-load-cache-toggle-cache)

(setenv "NEOVM_DISABLE_LOAD_CACHE_WRITE" " yes ")
(delete-file vm-load-cache-toggle-cache)
(load-file vm-load-cache-toggle-source)
(file-exists-p vm-load-cache-toggle-cache)

(setenv "NEOVM_DISABLE_LOAD_CACHE_WRITE" "On")
(delete-file vm-load-cache-toggle-cache)
(load-file vm-load-cache-toggle-source)
(file-exists-p vm-load-cache-toggle-cache)

(setenv "NEOVM_DISABLE_LOAD_CACHE_WRITE" "off")
(load-file vm-load-cache-toggle-source)
(file-exists-p vm-load-cache-toggle-cache)

(setenv "NEOVM_DISABLE_LOAD_CACHE_WRITE" "maybe")
(load-file vm-load-cache-toggle-source)
(file-exists-p vm-load-cache-toggle-cache)

(setenv "NEOVM_DISABLE_LOAD_CACHE_WRITE" "0")
(load-file vm-load-cache-toggle-source)
(file-exists-p vm-load-cache-toggle-cache)

(delete-file vm-load-cache-toggle-source)
(delete-file vm-load-cache-toggle-cache)
(delete-directory vm-load-cache-toggle-dir t)
(setenv "NEOVM_DISABLE_LOAD_CACHE_WRITE" nil)

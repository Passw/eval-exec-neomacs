; NeoVM extension policy: precompile cache reflects source changes.

(setq vm-precompile-rw-dir "/tmp/neovm-precompile-cache-rewrite/")
(progn (ignore-errors (delete-directory vm-precompile-rw-dir t)) (make-directory vm-precompile-rw-dir t) 'ok)

(setq vm-precompile-rw-source (concat vm-precompile-rw-dir "probe.el"))
(setq vm-precompile-rw-cache (concat vm-precompile-rw-dir "probe.neoc"))

(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-precompile-rw-src-v1*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert "(setq vm-precompile-rw-probe 'v1)")
        (insert (char-to-string 10))
        (write-region nil nil vm-precompile-rw-source nil nil))
    (set-buffer orig)
    (kill-buffer buf)))

(string= (neovm-precompile-file vm-precompile-rw-source) vm-precompile-rw-cache)
(file-exists-p vm-precompile-rw-cache)

(let ((text
       (let ((orig (current-buffer))
             (buf (get-buffer-create " *vm-precompile-rw-cache-v1*")))
         (unwind-protect
             (progn
               (set-buffer buf)
               (erase-buffer)
               (insert-file-contents vm-precompile-rw-cache)
               (buffer-string))
           (set-buffer orig)
           (kill-buffer buf)))))
  (setq vm-precompile-rw-cache-v1 text)
  (stringp vm-precompile-rw-cache-v1))

(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-precompile-rw-src-v2*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert ";;; -*- lexical-binding: t; -*-")
        (insert (char-to-string 10))
        (insert "(setq vm-precompile-rw-probe 'v2)")
        (insert (char-to-string 10))
        (write-region nil nil vm-precompile-rw-source nil nil))
    (set-buffer orig)
    (kill-buffer buf)))

(string= (neovm-precompile-file vm-precompile-rw-source) vm-precompile-rw-cache)
(file-exists-p vm-precompile-rw-cache)

(let ((text
       (let ((orig (current-buffer))
             (buf (get-buffer-create " *vm-precompile-rw-cache-v2*")))
         (unwind-protect
             (progn
               (set-buffer buf)
               (erase-buffer)
               (insert-file-contents vm-precompile-rw-cache)
               (buffer-string))
           (set-buffer orig)
           (kill-buffer buf)))))
  (setq vm-precompile-rw-cache-v2 text)
  (stringp vm-precompile-rw-cache-v2))

(not (string= vm-precompile-rw-cache-v1 vm-precompile-rw-cache-v2))
(and (not (null (string-match-p "source-hash=" vm-precompile-rw-cache-v1)))
     (not (null (string-match-p "source-hash=" vm-precompile-rw-cache-v2))))
(and (not (null (string-match-p "lexical=0" vm-precompile-rw-cache-v1)))
     (not (null (string-match-p "lexical=1" vm-precompile-rw-cache-v2))))

(delete-file vm-precompile-rw-source)
(delete-file vm-precompile-rw-cache)
(delete-directory vm-precompile-rw-dir t)

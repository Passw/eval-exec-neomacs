; USER-TIME designators that look like display handles should preserve
; display-query message payloads, regardless of DISPLAY designator shape.
(defun neovm-vm-compat-make-dead-window ()
  (let ((w (split-window)))
    (delete-window w)
    w))

(let* ((dead (neovm-vm-compat-make-dead-window))
       (display-args (list nil
                           "display"
                           1
                           'foo
                           [foo]
                           '(foo)
                           '(foo . bar)
                           (selected-frame)
                           (car (terminal-list))
                           (selected-window)
                           dead))
       (results (mapcar (lambda (display)
                          (condition-case err
                              (x-display-set-last-user-time display "x")
                            (error (list (car err) (cadr err)))))
                        display-args)))
  (equal results
         (make-list (length display-args)
                    '(error "Display x canâ€™t be opened"))))

(let* ((dead (neovm-vm-compat-make-dead-window))
       (display-args (list nil
                           "display"
                           1
                           'foo
                           [foo]
                           '(foo)
                           '(foo . bar)
                           (selected-frame)
                           (car (terminal-list))
                           (selected-window)
                           dead))
       (frame-user-time (selected-frame))
       (results (mapcar (lambda (display)
                          (condition-case err
                              (x-display-set-last-user-time display frame-user-time)
                            (error (list (car err) (cadr err)))))
                        display-args)))
  (equal results
         (make-list (length display-args)
                    '(error "Window system frame should be used"))))

(let* ((dead (neovm-vm-compat-make-dead-window))
       (display-args (list nil
                           "display"
                           1
                           'foo
                           [foo]
                           '(foo)
                           '(foo . bar)
                           (selected-frame)
                           (car (terminal-list))
                           (selected-window)
                           dead))
       (terminal-user-time (car (terminal-list)))
       (results (mapcar (lambda (display)
                          (condition-case err
                              (x-display-set-last-user-time display terminal-user-time)
                            (error (list (car err) (cadr err)))))
                        display-args)))
  (equal results
         (make-list (length display-args)
                    '(error "Terminal 0 is not an X display"))))

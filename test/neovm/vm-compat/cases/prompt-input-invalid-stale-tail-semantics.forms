; Prompt/input readers in batch should preserve unread-command-events across
; stale/invalid queue tails and avoid publishing recent-keys entries.

(progn
  (fset 'neo-prompt-queue-probe
        (lambda (fn args queue)
          (let ((start (length (recent-keys))))
            (setq unread-command-events queue)
            (condition-case err
                (progn
                  (apply fn args)
                  (list fn queue 'ok unread-command-events
                        (append (nthcdr start (append (recent-keys) nil)) nil)))
              (error
               (list fn queue (car err) unread-command-events
                     (append (nthcdr start (append (recent-keys) nil)) nil)))))))
  'probe-installed)

(let ((queues '((97 . foo)
                (foo . 97)
                ((mouse-1) . foo)
                (97 foo)
                (foo 97)
                ((mouse-1) 97)
                ([97] 98)
                [97 98]))
      (probes '((read-string "")
                (read-number "")
                (read-from-minibuffer "")
                (completing-read "" (("a") ("b")))
                (read-command "")
                (read-variable "")
                (read-buffer "")
                (read-file-name ""))))
  (mapcar
   (lambda (entry)
     (let ((fn (car entry))
           (args (cdr entry)))
       (mapcar (lambda (queue) (neo-prompt-queue-probe fn args queue)) queues)))
   probes))

(let ((queues '((97 . foo)
                (foo . 97)
                ((mouse-1) . foo)
                (97 foo)
                (foo 97)
                ((mouse-1) 97)
                ([97] 98)
                [97 98]))
      (probes '((y-or-n-p "Continue? ")
                (yes-or-no-p "Confirm? "))))
  (mapcar
   (lambda (entry)
     (let ((fn (car entry))
           (args (cdr entry)))
       (mapcar (lambda (queue) (neo-prompt-queue-probe fn args queue)) queues)))
   probes))

(let ((queues '((97 . foo)
                (foo . 97)
                ((mouse-1) . foo)
                (97 foo)
                (foo 97)
                ((mouse-1) 97)
                ([97] 98)
                [97 98]))
      (probes '((read-coding-system "Coding: ")
                (read-non-nil-coding-system "Coding: "))))
  (mapcar
   (lambda (entry)
     (let ((fn (car entry))
           (args (cdr entry)))
       (mapcar (lambda (queue) (neo-prompt-queue-probe fn args queue)) queues)))
   probes))

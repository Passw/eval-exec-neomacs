; NeoVM extension policy: `neovm-precompile-file` rejects compiled artifacts.

(setq vm-precompile-bad-dir "/tmp/neovm-precompile-compiled-reject/")
(progn (ignore-errors (delete-directory vm-precompile-bad-dir t)) (make-directory vm-precompile-bad-dir t) 'ok)

(setq vm-precompile-bad-elc (concat vm-precompile-bad-dir "probe.elc"))
(setq vm-precompile-bad-elc-gz (concat vm-precompile-bad-dir "probe.elc.gz"))
(setq vm-precompile-bad-cache (concat vm-precompile-bad-dir "probe.neoc"))
(setq vm-precompile-bad-cache-gz (concat vm-precompile-bad-dir "probe.elc.neoc"))
(setq vm-precompile-bad-cache-tmp (concat vm-precompile-bad-dir "probe.neoc.tmp"))
(setq vm-precompile-bad-cache-gz-tmp (concat vm-precompile-bad-dir "probe.elc.neoc.tmp"))

(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-precompile-bad-elc*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert "compiled-artifact")
        (write-region nil nil vm-precompile-bad-elc nil nil))
    (set-buffer orig)
    (kill-buffer buf)))

(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-precompile-bad-elc-gz*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert "compiled-artifact-gz")
        (write-region nil nil vm-precompile-bad-elc-gz nil nil))
    (set-buffer orig)
    (kill-buffer buf)))

(condition-case err (neovm-precompile-file vm-precompile-bad-elc) (error (car err)))
(condition-case err (neovm-precompile-file vm-precompile-bad-elc-gz) (error (car err)))
(let ((err (condition-case err (neovm-precompile-file vm-precompile-bad-elc) (error err))))
  (and
   (eq (car err) 'file-error)
   (stringp (cadr err))
   (not (null (string-match-p "compiled artifacts" (cadr err))))
   (not (null (string-match-p "probe\\.elc" (cadr err))))))
(let ((err (condition-case err (neovm-precompile-file vm-precompile-bad-elc-gz) (error err))))
  (and
   (eq (car err) 'file-error)
   (stringp (cadr err))
   (not (null (string-match-p "compiled artifacts" (cadr err))))
   (not (null (string-match-p "probe\\.elc\\.gz" (cadr err))))))
(file-exists-p vm-precompile-bad-cache)
(file-exists-p vm-precompile-bad-cache-gz)
(file-exists-p vm-precompile-bad-cache-tmp)
(file-exists-p vm-precompile-bad-cache-gz-tmp)

(delete-file vm-precompile-bad-elc)
(delete-file vm-precompile-bad-elc-gz)
(delete-directory vm-precompile-bad-dir t)

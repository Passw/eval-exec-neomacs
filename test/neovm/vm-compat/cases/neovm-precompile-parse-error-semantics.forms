; NeoVM extension policy: parse errors during precompile surface
; `invalid-read-syntax` and do not emit cache artifacts.

(setq vm-precompile-parse-dir "/tmp/neovm-precompile-parse-error/")
(progn (ignore-errors (delete-directory vm-precompile-parse-dir t)) (make-directory vm-precompile-parse-dir t) 'ok)

(setq vm-precompile-parse-source (concat vm-precompile-parse-dir "broken.el"))
(setq vm-precompile-parse-cache (concat vm-precompile-parse-dir "broken.neoc"))
(setq vm-precompile-parse-cache-tmp (concat vm-precompile-parse-dir "broken.neoc.tmp"))

(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-precompile-parse*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert ";;; -*- lexical-binding: t; -*-")
        (insert (char-to-string 10))
        (insert "(setq vm-precompile-parse-probe 1")
        (insert (char-to-string 10))
        (write-region nil nil vm-precompile-parse-source nil nil))
    (set-buffer orig)
    (kill-buffer buf)))

(condition-case err (neovm-precompile-file vm-precompile-parse-source) (error (car err)))
(let ((err (condition-case err (neovm-precompile-file vm-precompile-parse-source) (error err))))
  (and
   (eq (car err) 'invalid-read-syntax)
   (stringp (cadr err))
   (not (null (string-match-p "Parse error in" (cadr err))))
   (not (null (string-match-p "broken\\.el" (cadr err))))))
(file-exists-p vm-precompile-parse-cache)
(file-exists-p vm-precompile-parse-cache-tmp)

(delete-file vm-precompile-parse-source)
(delete-directory vm-precompile-parse-dir t)

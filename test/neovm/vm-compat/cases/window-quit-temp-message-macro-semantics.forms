; Macro compatibility for save-window-excursion/save-selected-window/with-local-quit/with-temp-message.
(fboundp 'save-window-excursion)
(macrop 'save-window-excursion)
(special-form-p 'save-window-excursion)
(functionp 'save-window-excursion)
(func-arity 'save-window-excursion)
(func-arity (indirect-function 'save-window-excursion))

(fboundp 'save-selected-window)
(macrop 'save-selected-window)
(special-form-p 'save-selected-window)
(functionp 'save-selected-window)
(func-arity 'save-selected-window)
(func-arity (indirect-function 'save-selected-window))

(fboundp 'with-local-quit)
(macrop 'with-local-quit)
(special-form-p 'with-local-quit)
(functionp 'with-local-quit)
(func-arity 'with-local-quit)
(func-arity (indirect-function 'with-local-quit))

(fboundp 'with-temp-message)
(macrop 'with-temp-message)
(special-form-p 'with-temp-message)
(functionp 'with-temp-message)
(func-arity 'with-temp-message)
(func-arity (indirect-function 'with-temp-message))
(fboundp 'internal--before-save-selected-window)
(func-arity 'internal--before-save-selected-window)
(fboundp 'internal--after-save-selected-window)
(func-arity 'internal--after-save-selected-window)

(let ((w1 (selected-window))
      (w2 (split-window (selected-window))))
  (prog1
      (list
       (save-window-excursion
         (select-window w2)
         (eq (selected-window) w2))
       (eq (selected-window) w1))
    (ignore-errors (delete-window w2))))
(let ((w1 (selected-window))
      (w2 (split-window (selected-window))))
  (prog1
      (list
       (condition-case err
           (save-window-excursion
             (select-window w2)
             (error "boom"))
         (error (car err)))
       (eq (selected-window) w1))
    (ignore-errors (delete-window w2))))

(let ((w1 (selected-window))
      (w2 (split-window (selected-window))))
  (prog1
      (list
       (save-selected-window
         (select-window w2)
         (eq (selected-window) w2))
       (eq (selected-window) w1))
    (ignore-errors (delete-window w2))))
(let ((w1 (selected-window))
      (w2 (split-window (selected-window))))
  (prog1
      (list
       (condition-case err
           (save-selected-window
             (select-window w2)
             (error "boom"))
         (error (car err)))
       (eq (selected-window) w1))
    (ignore-errors (delete-window w2))))

(with-local-quit 'after)
(let ((inhibit-quit t))
  (with-local-quit inhibit-quit))
(condition-case err
    (with-local-quit (error "boom"))
  (error (car err)))

(with-temp-message nil 42)
(with-temp-message "tmp" 7)
(condition-case err
    (with-temp-message)
  (error (car err)))
(eval (macroexpand '(with-local-quit 'after)))
(eval (macroexpand '(with-temp-message nil 42)))

(let ((before (length (window-list))))
  (list
   (save-window-excursion
     (split-window (selected-window))
     (length (window-list)))
   (length (window-list))
   before))
(let ((before (length (window-list))))
  (let ((expanded (macroexpand '(save-window-excursion
                                  (split-window (selected-window))
                                  (length (window-list))))))
    (list (eval expanded)
          (length (window-list))
          before)))
(let ((w1 (selected-window))
      (w2 (split-window (selected-window))))
  (prog1
      (list
       (let ((expanded (macroexpand '(save-selected-window
                                      (select-window w2)
                                      (eq (selected-window) w2)))))
         (eval expanded))
       (eq (selected-window) w1))
    (ignore-errors (delete-window w2))))

(macroexpand '(save-window-excursion (selected-window)))
(macroexpand '(save-selected-window (selected-window)))
(macroexpand '(with-local-quit (selected-window)))
(macroexpand '(with-temp-message "x" (selected-window)))

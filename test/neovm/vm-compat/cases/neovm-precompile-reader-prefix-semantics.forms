; NeoVM extension policy: `neovm-precompile-file` should handle reader prefixes
; (UTF-8 BOM, shebang with lexical-binding cookie, and shebang non-cookie text)
; with the same runtime semantics as direct `load-file`.

(setq vm-precompile-prefix-dir "/tmp/neovm-precompile-reader-prefix/")
(progn (ignore-errors (delete-directory vm-precompile-prefix-dir t)) (make-directory vm-precompile-prefix-dir t) 'ok)

; BOM-prefixed source.
(setq vm-precompile-prefix-bom-source (concat vm-precompile-prefix-dir "bom.el"))
(setq vm-precompile-prefix-bom-cache (concat vm-precompile-prefix-dir "bom.neoc"))
(ignore-errors (makunbound 'vm-precompile-prefix-bom-probe))

(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-precompile-prefix-bom-src*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert (char-to-string 65279))
        (insert "(setq vm-precompile-prefix-bom-probe 'bom)")
        (insert (char-to-string 10))
        (write-region nil nil vm-precompile-prefix-bom-source nil nil))
    (set-buffer orig)
    (kill-buffer buf)))

(string= (neovm-precompile-file vm-precompile-prefix-bom-source) vm-precompile-prefix-bom-cache)
(file-exists-p vm-precompile-prefix-bom-cache)
(boundp 'vm-precompile-prefix-bom-probe)
(load-file vm-precompile-prefix-bom-source)
(eq vm-precompile-prefix-bom-probe 'bom)

; Shebang source with second-line lexical-binding cookie.
(setq vm-precompile-prefix-shebang-source (concat vm-precompile-prefix-dir "shebang.el"))
(setq vm-precompile-prefix-shebang-cache (concat vm-precompile-prefix-dir "shebang.neoc"))
(ignore-errors (makunbound 'vm-precompile-prefix-shebang-probe))
(ignore-errors (makunbound 'vm-precompile-prefix-shebang-fn))

(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-precompile-prefix-shebang-src*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert "#!/usr/bin/env emacs --script")
        (insert (char-to-string 10))
        (insert ";; -*- lexical-binding: t; -*-")
        (insert (char-to-string 10))
        (insert "(setq vm-precompile-prefix-shebang-probe lexical-binding)")
        (insert (char-to-string 10))
        (insert "(setq vm-precompile-prefix-shebang-fn (let ((x 41)) (lambda () (+ x 1))))")
        (insert (char-to-string 10))
        (write-region nil nil vm-precompile-prefix-shebang-source nil nil))
    (set-buffer orig)
    (kill-buffer buf)))

(string= (neovm-precompile-file vm-precompile-prefix-shebang-source) vm-precompile-prefix-shebang-cache)
(file-exists-p vm-precompile-prefix-shebang-cache)
(boundp 'vm-precompile-prefix-shebang-probe)
(load-file vm-precompile-prefix-shebang-source)
(eq vm-precompile-prefix-shebang-probe t)
(let ((lexical-binding nil)) (funcall vm-precompile-prefix-shebang-fn))

; Shebang source with non-cookie text must remain dynamically scoped.
(setq vm-precompile-prefix-noncookie-source (concat vm-precompile-prefix-dir "noncookie.el"))
(setq vm-precompile-prefix-noncookie-cache (concat vm-precompile-prefix-dir "noncookie.neoc"))
(ignore-errors (makunbound 'vm-precompile-prefix-noncookie-probe))
(ignore-errors (makunbound 'vm-precompile-prefix-noncookie-fn))

(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-precompile-prefix-noncookie-src*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert "#!/usr/bin/env emacs --script")
        (insert (char-to-string 10))
        (insert "(setq vm-precompile-prefix-noncookie-string \"lexical-binding: t\")")
        (insert (char-to-string 10))
        (insert "(setq vm-precompile-prefix-noncookie-probe lexical-binding)")
        (insert (char-to-string 10))
        (insert "(setq vm-precompile-prefix-noncookie-fn (let ((x 41)) (lambda () (+ x 1))))")
        (insert (char-to-string 10))
        (write-region nil nil vm-precompile-prefix-noncookie-source nil nil))
    (set-buffer orig)
    (kill-buffer buf)))

(string= (neovm-precompile-file vm-precompile-prefix-noncookie-source) vm-precompile-prefix-noncookie-cache)
(file-exists-p vm-precompile-prefix-noncookie-cache)
(boundp 'vm-precompile-prefix-noncookie-probe)
(load-file vm-precompile-prefix-noncookie-source)
(eq vm-precompile-prefix-noncookie-probe nil)
(condition-case err (let ((lexical-binding nil)) (funcall vm-precompile-prefix-noncookie-fn)) (error (list 'error (car err))))

; Single-line shebang should preserve end-of-file signaling.
(setq vm-precompile-prefix-shebang-eof-source (concat vm-precompile-prefix-dir "shebang-eof.el"))
(ignore-errors (delete-file vm-precompile-prefix-shebang-eof-source))

(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-precompile-prefix-shebang-eof-src*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert "#!/usr/bin/env emacs --script")
        (write-region nil nil vm-precompile-prefix-shebang-eof-source nil nil))
    (set-buffer orig)
    (kill-buffer buf)))

(condition-case err (neovm-precompile-file vm-precompile-prefix-shebang-eof-source) (error (list 'error (car err))))

(delete-file vm-precompile-prefix-bom-source)
(delete-file vm-precompile-prefix-bom-cache)
(delete-file vm-precompile-prefix-shebang-source)
(delete-file vm-precompile-prefix-shebang-cache)
(delete-file vm-precompile-prefix-noncookie-source)
(delete-file vm-precompile-prefix-noncookie-cache)
(delete-file vm-precompile-prefix-shebang-eof-source)
(delete-directory vm-precompile-prefix-dir t)

(ignore-errors (makunbound 'vm-precompile-prefix-bom-probe))
(ignore-errors (makunbound 'vm-precompile-prefix-shebang-probe))
(ignore-errors (makunbound 'vm-precompile-prefix-shebang-fn))
(ignore-errors (makunbound 'vm-precompile-prefix-noncookie-probe))
(ignore-errors (makunbound 'vm-precompile-prefix-noncookie-fn))

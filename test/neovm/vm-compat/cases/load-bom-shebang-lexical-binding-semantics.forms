; Combined reader prefix behavior: UTF-8 BOM + shebang should still honor
; second-line lexical-binding cookie (and reject non-cookie lookalikes).

(progn
  (setq vm-load-bom-shebang-source "/tmp/neovm-load-bom-shebang-lexical-binding-semantics.el")
  'ok)
(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-load-bom-shebang-src*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert (char-to-string 65279))
        (insert "#!/usr/bin/env emacs --script")
        (insert (char-to-string 10))
        (insert ";; -*- lexical-binding: t; -*-")
        (insert (char-to-string 10))
        (insert "(setq vm-load-bom-shebang-probe lexical-binding)")
        (insert (char-to-string 10))
        (insert "(setq vm-load-bom-shebang-fn (let ((x 41)) (lambda () (+ x 1))))")
        (insert (char-to-string 10))
        (write-region nil nil vm-load-bom-shebang-source nil nil))
    (set-buffer orig)
    (kill-buffer buf)))
(load vm-load-bom-shebang-source nil t)
vm-load-bom-shebang-probe
(let ((lexical-binding nil)) (funcall vm-load-bom-shebang-fn))
(ignore-errors (delete-file vm-load-bom-shebang-source))

(progn
  (setq vm-load-bom-shebang-noncookie-source "/tmp/neovm-load-bom-shebang-lexical-binding-noncookie-semantics.el")
  'ok)
(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-load-bom-shebang-noncookie-src*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert (char-to-string 65279))
        (insert "#!/usr/bin/env emacs --script")
        (insert (char-to-string 10))
        (insert "(setq vm-load-bom-shebang-noncookie-string \"lexical-binding: t\")")
        (insert (char-to-string 10))
        (insert "(setq vm-load-bom-shebang-noncookie-probe lexical-binding)")
        (insert (char-to-string 10))
        (insert "(setq vm-load-bom-shebang-noncookie-fn (let ((x 41)) (lambda () (+ x 1))))")
        (insert (char-to-string 10))
        (write-region nil nil vm-load-bom-shebang-noncookie-source nil nil))
    (set-buffer orig)
    (kill-buffer buf)))
(load vm-load-bom-shebang-noncookie-source nil t)
vm-load-bom-shebang-noncookie-probe
(condition-case err (let ((lexical-binding nil)) (funcall vm-load-bom-shebang-noncookie-fn)) (error (list 'error (car err))))
(ignore-errors (delete-file vm-load-bom-shebang-noncookie-source))

; save-mark-and-excursion macro boundary: introspection, state restore, macroexpand shape.
(fboundp 'save-mark-and-excursion)
(macrop 'save-mark-and-excursion)
(special-form-p 'save-mark-and-excursion)
(functionp 'save-mark-and-excursion)
(func-arity 'save-mark-and-excursion)
(func-arity (indirect-function 'save-mark-and-excursion))
(save-current-buffer
  (let ((b (get-buffer-create "smx-vm-compat")))
    (set-buffer b)
    (erase-buffer)
    (insert "abcdef")
    (goto-char 2)
    (set-mark 5)
    (setq mark-active nil)
    (let ((before (list (point) (mark) mark-active)))
      (save-mark-and-excursion
        (goto-char 4)
        (set-mark 3)
        (setq mark-active t))
      (list before (point) (mark) mark-active))))
(save-current-buffer
  (let ((b (get-buffer-create "smx-vm-compat-err")))
    (set-buffer b)
    (erase-buffer)
    (insert "abcdef")
    (goto-char 2)
    (set-mark 5)
    (setq mark-active nil)
    (list (condition-case err
              (save-mark-and-excursion
                (goto-char 4)
                (set-mark 3)
                (setq mark-active t)
                (error "boom"))
            (error (car err)))
          (point)
          (mark)
          mark-active)))
(macroexpand '(save-mark-and-excursion (setq x 1)))

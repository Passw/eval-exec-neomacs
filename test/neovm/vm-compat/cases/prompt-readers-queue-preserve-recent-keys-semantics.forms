; Batch prompt/input readers should preserve unread-command-events payloads and
; avoid publishing recent-keys across mixed queue shapes.

(let ((probes '((read-file-name "")
                (read-directory-name "")
                (read-buffer "")
                (read-command "")
                (read-variable "")
                (read-from-minibuffer "")
                (read-string "")
                (read-number "")
                (completing-read "" (("a") ("b")))))
      (queues '((97 foo)
                (foo 97)
                ((mouse-1) 97)
                ([97] 98)
                (foo . 97)
                [97 98])))
  (mapcar
   (lambda (entry)
     (let ((fn (car entry))
           (args (cdr entry)))
       (mapcar
        (lambda (queue)
          (let ((start (length (recent-keys))))
            (setq unread-command-events queue)
            (condition-case err
                (progn
                  (apply fn args)
                  (list fn queue 'ok unread-command-events
                        (append (nthcdr start (append (recent-keys) nil)) nil)))
              (error
               (list fn queue (car err) unread-command-events
                     (append (nthcdr start (append (recent-keys) nil)) nil))))))
        queues)))
   probes))

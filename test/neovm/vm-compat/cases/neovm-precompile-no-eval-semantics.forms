; NeoVM extension policy: `neovm-precompile-file` parses/writes cache
; without evaluating top-level forms from the source.

(setq vm-precompile-no-eval-dir "/tmp/neovm-precompile-no-eval/")
(progn (ignore-errors (delete-directory vm-precompile-no-eval-dir t)) (make-directory vm-precompile-no-eval-dir t) 'ok)

(setq vm-precompile-no-eval-source (concat vm-precompile-no-eval-dir "probe.el"))
(setq vm-precompile-no-eval-cache (concat vm-precompile-no-eval-dir "probe.neoc"))

(ignore-errors (makunbound 'vm-precompile-no-eval-probe))

(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-precompile-no-eval-src*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert "(setq vm-precompile-no-eval-probe 'from-source)")
        (insert (char-to-string 10))
        (write-region nil nil vm-precompile-no-eval-source nil nil))
    (set-buffer orig)
    (kill-buffer buf)))

(boundp 'vm-precompile-no-eval-probe)
(string= (neovm-precompile-file vm-precompile-no-eval-source) vm-precompile-no-eval-cache)
(file-exists-p vm-precompile-no-eval-cache)
(boundp 'vm-precompile-no-eval-probe)
(condition-case err vm-precompile-no-eval-probe (error (car err)))

(setq vm-precompile-no-eval-probe 'seed)
(eq vm-precompile-no-eval-probe 'seed)
(string= (neovm-precompile-file vm-precompile-no-eval-source) vm-precompile-no-eval-cache)
(file-exists-p vm-precompile-no-eval-cache)
(eq vm-precompile-no-eval-probe 'seed)

(load-file vm-precompile-no-eval-source)
(boundp 'vm-precompile-no-eval-probe)
(eq vm-precompile-no-eval-probe 'from-source)

(delete-file vm-precompile-no-eval-source)
(delete-file vm-precompile-no-eval-cache)
(delete-directory vm-precompile-no-eval-dir t)
(makunbound 'vm-precompile-no-eval-probe)

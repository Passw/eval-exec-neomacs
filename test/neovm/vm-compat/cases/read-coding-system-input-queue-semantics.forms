; Batch read-coding-system* should ignore unread-command-events payloads and
; avoid publishing recent-keys history.

(progn
  (fset 'neo-read-coding-probe
        (lambda (fn queue)
          (let ((start (length (recent-keys))))
            (setq unread-command-events queue)
            (condition-case err
                (progn
                  (funcall fn "Coding: ")
                  (list fn
                        queue
                        'ok
                        unread-command-events
                        (append (nthcdr start (append (recent-keys) nil)) nil)))
              (error
               (list fn
                     queue
                     (car err)
                     unread-command-events
                     (append (nthcdr start (append (recent-keys) nil)) nil)))))))
  'probe-installed)

(neo-read-coding-probe 'read-coding-system (list 97 'foo))
(neo-read-coding-probe 'read-coding-system (list 'foo 97))
(neo-read-coding-probe 'read-coding-system (list '(mouse-1) 97))
(neo-read-coding-probe 'read-coding-system (list [97] 98))
(neo-read-coding-probe 'read-coding-system '(foo . 97))
(neo-read-coding-probe 'read-coding-system [97 98])

(neo-read-coding-probe 'read-non-nil-coding-system (list 97 'foo))
(neo-read-coding-probe 'read-non-nil-coding-system (list 'foo 97))
(neo-read-coding-probe 'read-non-nil-coding-system (list '(mouse-1) 97))
(neo-read-coding-probe 'read-non-nil-coding-system (list [97] 98))
(neo-read-coding-probe 'read-non-nil-coding-system '(foo . 97))
(neo-read-coding-probe 'read-non-nil-coding-system [97 98])

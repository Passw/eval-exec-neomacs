; `set-window-buffer` should restore per-window state per buffer and honor
; KEEP-MARGINS: nil/omitted resets margins, non-nil preserves them.

(let* ((w (selected-window))
       (b1 (get-buffer-create "swb-state-a"))
       (b2 (get-buffer-create "swb-state-b")))
  (with-current-buffer b1
    (erase-buffer)
    (insert (make-string 300 ?a))
    (goto-char 120))
  (with-current-buffer b2
    (erase-buffer)
    (insert (make-string 300 ?b))
    (goto-char 150))

  (set-window-buffer w b1)
  (set-window-start w 110)
  (set-window-point w 120)
  (set-window-margins w 3 4)

  (let (initial after-b2 back-b1-keep back-b2-keep back-b1-reset)
    (setq initial (list (window-start w) (window-point w) (window-margins w)))

    (set-window-buffer w b2)
    (setq after-b2 (list (window-start w) (window-point w) (window-margins w)))

    (set-window-margins w 7 8)
    (set-window-buffer w b1 t)
    (setq back-b1-keep (list (window-start w) (window-point w) (window-margins w)))

    (set-window-margins w 9 10)
    (set-window-buffer w b2 t)
    (setq back-b2-keep (list (window-start w) (window-point w) (window-margins w)))

    (set-window-margins w 11 12)
    (set-window-buffer w b1 nil)
    (setq back-b1-reset (list (window-start w) (window-point w) (window-margins w)))

    (list initial after-b2 back-b1-keep back-b2-keep back-b1-reset)))

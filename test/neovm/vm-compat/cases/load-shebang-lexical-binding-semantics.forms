; shebang-prefixed source should load, and second-line lexical-binding cookie must apply.
(progn
  (setq vm-load-shebang-source "/tmp/neovm-load-shebang-lexical-binding-semantics.el")
  'ok)
(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-load-shebang-src*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert "#!/usr/bin/env emacs --script")
        (insert (char-to-string 10))
        (insert ";; -*- lexical-binding: t; -*-")
        (insert (char-to-string 10))
        (insert "(setq vm-load-shebang-probe lexical-binding)")
        (insert (char-to-string 10))
        (insert "(setq vm-load-shebang-fn (let ((x 41)) (lambda () (+ x 1))))")
        (insert (char-to-string 10))
        (write-region nil nil vm-load-shebang-source nil nil))
    (set-buffer orig)
    (kill-buffer buf)))
(load vm-load-shebang-source nil t)
vm-load-shebang-probe
(let ((lexical-binding nil)) (funcall vm-load-shebang-fn))
(ignore-errors (delete-file vm-load-shebang-source))

; Non-cookie second-line text must not force lexical-binding.
(progn
  (setq vm-load-shebang-noncookie-source "/tmp/neovm-load-shebang-lexical-binding-noncookie-semantics.el")
  'ok)
(let ((orig (current-buffer))
      (buf (get-buffer-create " *vm-load-shebang-noncookie-src*")))
  (unwind-protect
      (progn
        (set-buffer buf)
        (erase-buffer)
        (insert "#!/usr/bin/env emacs --script")
        (insert (char-to-string 10))
        (insert "(setq vm-load-shebang-noncookie-string \"lexical-binding: t\")")
        (insert (char-to-string 10))
        (insert "(setq vm-load-shebang-noncookie-probe lexical-binding)")
        (insert (char-to-string 10))
        (insert "(setq vm-load-shebang-noncookie-fn (let ((x 41)) (lambda () (+ x 1))))")
        (insert (char-to-string 10))
        (write-region nil nil vm-load-shebang-noncookie-source nil nil))
    (set-buffer orig)
    (kill-buffer buf)))
(load vm-load-shebang-noncookie-source nil t)
vm-load-shebang-noncookie-probe
(condition-case err (let ((lexical-binding nil)) (funcall vm-load-shebang-noncookie-fn)) (error (list 'error (car err))))
(ignore-errors (delete-file vm-load-shebang-noncookie-source))

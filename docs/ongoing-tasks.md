# Ongoing NeoVM Tasks

This is an auto-updating log for incremental NeoVM rewrite slices that should keep landing in regular verified batches.

## Current focus areas
1. **Compatibility slices** – keep expanding `test/neovm/vm-compat` cases (window/frame semantics, timers, inputs, display primitives). Every addition must gate on `check-all-neovm` and matching Oracle TSVs.
2. **Rust core backend** – keep `core-backend-rust` as the default path, use `core-backend-emacs-c` only as a short-lived rollback switch, and remove fallback paths as tracker rows reach `rust-default`/`c-removed`.
3. **Concurrency model** – reinforce the isolate-first scheduler (`neovm-worker`), message passing, and Specpdl isolation across isolates while keeping the host/VM boundary clean.
4. **Platform guidance** – expand README platform notes and link to issue #22 for macOS, plus consider creating future follow-ups for Windows/other hosts once a stable build path exists.

## Auto-exploration queue
These are the next candidate slices to explore automatically (an initial 20 tasks is already in `docs/neomacs-direct-c-to-rust-plan.md`; keep advancing through them in order, re-checking Oracle behavior each time). Track progress with verified batches and push after each slice.

## Next actionable move
- Identify the next VM builtin still stubbed or drifting (the plan references process/file wrappers, display/window, and stub enforcement). Implement a targeted lock-in slice with new corpus cases and `check-neovm` regression checks.
- Recent completed slice: `start-process` now matches oracle buffer/program/name/arg contracts (including buffer-object designators and strict arg typing), locked by `cases/start-process-buffer-and-type-contract-semantics`.
- Recent completed slice: `call-process`/`call-process-region`/`start-file-process` now enforce oracle string contracts (with `PROGRAM=nil` preserved where required), locked by `cases/call-process-start-file-process-string-contract-semantics`.
- Recent completed slice: `accept-process-output` now matches oracle millisecond/fixnum contract and error payload order, locked by `cases/accept-process-output-millis-semantics`.
- Recent completed slice: stale process mutators now match oracle for control-surface setters (`set-process-*`, `process-put`, `process-get`), locked by `cases/process-stale-mutator-semantics`.
- Recent completed slice: stale process control operations now match oracle inactive-process signaling behavior for `continue/interrupt/kill/stop/quit-process`, locked by `cases/process-stale-control-semantics`.
- Recent completed slice: `process-attributes` now matches oracle runtime identity-field shape (`user`/`group`/`euid`/`egid`) and negative PID semantics (`-1` -> `nil`), locked by `cases/process-attributes-runtime-semantics`.
- Recent completed slice: `make-serial-process` now enforces oracle `:port` type contracts (`wrong-type-argument stringp` for non-string ports, `nil` still treated as missing), locked by `cases/process-serial-port-contract-semantics`.
- Recent completed slice: `process-tty-name` now tracks tty presence by process kind/stream (real process stream selectors remain tty-backed, pipe/network selectors return `nil`, including stale handles), locked by `cases/process-tty-stream-kind-semantics`.
- Recent completed slice: `set-binary-mode` now matches oracle unsupported-stream errors (`(error "unsupported stream" <sym>)`) via `cases/file-runtime-wrapper-semantics`.
- Recent completed slice: `frame-edges` now preserves oracle-style live-window buffer context in `is not a live frame` messages, with `cases/frame-edges-window-message-semantics` added and gated.
- Recent completed slice: added dead-window payload lock-ins for `frame-terminal`/`terminal-name`/`tty-type`/`controlling-tty-p`/`suspend-tty`/`resume-tty` via `cases/terminal-dead-window-error-payload-semantics`.
- Recent completed slice: aligned vm-compat runner case serialization with oracle (`elisp_compat_runner` now escapes only newline/carriage-return/tab, not backslashes), unblocking strict-form parity for `cases/documentation-property-semantics`.
- Recent completed slice: aligned startup doc seeds for `use-system-tooltips` and `ctl-x-4-map` with oracle-facing `documentation-property` behavior, and refreshed `cases/documentation-property-semantics.expected.tsv` to lock the corrected tuples.
- Recent completed slice: hardened vm-compat runner emission to preserve raw result bytes and oracle-equivalent control-escape forms (including `\\t`/`\\n` strict-form parity), plus strengthened the `use-system-tooltips` prefix probe back to an alignment assertion.
- Recent completed slice: fixed neovm-worker broken build (removed stale legacy-elc-literal feature, adapted SymId migration in eval_error_to_task_error).
- Recent completed slice: added garbage-collect-heapsize builtin (last missing alloc.c DEFUN), completing all 23 alloc.c DEFUNs in Rust dispatch.
- Recent completed slice: wired 7 placeholder modules (buffer, callproc, character, data, dispnew, terminal, xfaces) into elisp/mod.rs for C-file-parallel module infrastructure.
- Recent completed slice: fixed SymId interner for cross-thread worker (Evaluator::setup_thread_locals, compat runner restructure), unblocking all vm-compat case execution.
- Recent completed slice: created oracle lock-in cases for data.c (62 cases), alloc.c (12 cases), character.c (9 cases), all matching GNU Emacs oracle. Tracker updated to partial for all three.
- Recent completed slice: fns.c oracle sweep — created 6 new vm-compat case files (250 forms total) covering sequence/list ops, string comparison/search, hash table introspection, equality/association, base64/crypto, and misc fns.c DEFUNs. Fixed proper-list-p (returns length not t), clear-string (actually zeros string), compare-strings (0-based indexing), string-search (negative start validation), string-distance (full Levenshtein implementation), rassoc (non-list error), base64-decode-string (signals error on invalid input). All 4540 tests pass. Tracker updated fns.c to rust-default.
- **Full partial→rust-default sweep (2026-02-25)** — swept all 38 remaining partial C files through oracle lock-in verification. Results:
  - **35 C files promoted to `rust-default`** (up from 3 before the sweep): alloc, buffer, casefiddle, casetab, category, ccl, character, charset, chartab, coding, comp, composite, data, dired, doc, editfns, eval, fileio, floatfns, font, image, indent, json, keyboard, keymap, lread, marker, minibuf, print, search, syntax, textprop, thread, timefns, undo, window, xdisp, xml.
  - **25 new oracle lock-in case files** (~490 forms) across 10 batches.
  - **1 Rust fix**: floor/ceiling/round/truncate now support optional divisor argument (2-arg form) matching Emacs semantics.
  - **3 files remain partial** (justified): itree.c (0 DEFUNs, internal), regex-emacs.c (0 DEFUNs, internal), profiler.c (timing-dependent output).
  - All 4540 tests pass; full `check-all-neovm` gate green.
- Recent completed slice: promoted `process.c` (64 DEFUNs, 39 oracle case files) and `callproc.c` (3 DEFUNs) to `rust-default`, covering runtime introspection, stale-handle mutators/control, process-attributes, serial-port contracts, tty-stream semantics, network signals, shell wrappers, and more.
- Recent completed slice: extracted terminal builtins into dedicated `terminal/pure.rs` module — 32 builtins (terminal-name, terminal-list, frame-terminal, terminal-live-p, terminal-parameter, set-terminal-parameter, tty-type, tty-top-frame, tty-display-color-p, tty-display-color-cells, tty-no-underline, controlling-tty-p, suspend-tty, resume-tty, delete-terminal, make-terminal-frame + eval variants) moved from display.rs and builtins.rs. All terminal thread-local state and helpers extracted. Pure refactor, no behavioral changes. 4555 tests pass.
- Recent completed slice: extracted dispnew builtins into dedicated `dispnew/pure.rs` module — 13 builtins (redraw-frame, redraw-display, open-termscript, ding, send-string-to-terminal, internal-show-cursor, internal-show-cursor-p, force-window-update + eval variants) moved from display.rs and builtins.rs. All cursor thread-local state and window designator helpers extracted. Pure refactor, no behavioral changes. 4569 tests pass.
- Recent completed slice: promoted `frame.c` (67 DEFUNs, 5 new stubs: frame-id, frame-windows-min-size, frame-root-frame, set-frame-size-and-position-pixelwise, mouse-position-in-root-frame), `xfaces.c` (29 DEFUNs, 1 new: x-load-color-file with real RGB file parser), `dispnew.c` (12 DEFUNs, all already dispatched), `ftfont.c` and `ftcrfont.c` (0 DEFUNs, rendering in Rust neomacs-display) to `rust-default`. All 5 display infrastructure C files complete.
- Keep documenting the auto-progress in the plan (update `docs/neomacs-direct-c-to-rust-plan.md` `## Doing` and `## Next`) each time a slice is completed.
- Track recent slices such as the `recent-keys` capture for `call-interactively`/`command-execute` so their documentation stays visible for observers and CI log correlation.
- Refer to `docs/neovm-subsystem-porting.md` when choosing the next subsystem to port; it lists the untracked Rust modules and the gated steps to bring each online.
